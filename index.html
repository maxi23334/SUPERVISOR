<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>EL VIGILANTE ‚Äì Inicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#111; --fg:#fff; --mut:#bbb; --card:#171717; --border:#2a2a2a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--fg);min-height:100vh;display:flex;flex-direction:column}
    header{text-align:center;padding:18px}
    .logo{width:120px;margin-bottom:10px}
    h1{margin:6px 0 0}
    .menu{display:flex;flex-direction:column;gap:12px;align-items:center;margin:12px 0 24px}
    button{background:#333;color:#fff;border:none;border-radius:6px;padding:14px 22px;font-size:1.1rem;cursor:pointer;transition:.2s}
    button:hover{background:#555}
    .adminBtn{margin-top:6px;font-size:.95rem;padding:10px 16px;background:#222}
    .muted{color:var(--mut);font-size:.95rem}
    /* Admin panel */
    #adminPanel{display:none}
    .wrap{padding:12px 16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    input,select{padding:10px;border-radius:8px;border:1px solid var(--border);background:#1b1b1b;color:#fff}
    #map{flex:1;min-height:60vh;margin:10px 16px;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#1b1b1b;margin-left:6px}
    .ok{color:#9fe29f}.warn{color:#ffd27a}.err{color:#ff8a8a}
  </style>
  <!-- Leaflet para el mapa de admin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>
<body>

  <!-- Vista VIGILADOR (p√∫blica) -->
  <header id="vigHeader">
    <img src="img/escudo.png" alt="Escudo" class="logo">
    <h1>EL VIGILANTE</h1>
    <p class="muted">Seleccion√° una opci√≥n</p>
  </header>

  <div id="vigMenu" class="menu">
    <button onclick="location.href='ingreso-salida.html'">üö™ Ingreso y Salida</button>
    <button onclick="location.href='rondas.html'">üìù Rondas</button>
    <button onclick="location.href='objetivo-mapa.html'">üìç Objetivo (Mapa √∫nico)</button>
    <button class="adminBtn" id="btnAdmin">üîí Ingresar como administrador</button>
  </div>

  <!-- Panel ADMIN (protegido por contrase√±a) -->
  <div id="adminPanel">
    <header>
      <h1>Panel de administrador</h1>
      <p class="muted">Monitoreo en vivo ‚Äì cada marca agrega un pin en este mapa.</p>
      <button class="adminBtn" onclick="logoutAdmin()">Salir de admin</button>
    </header>

    <div class="wrap">
      <div class="card">
        <div class="muted">Objetivo</div>
        <input id="objetivo" placeholder="Objetivo fijo" style="min-width:240px">
        <button onclick="aplicarObjetivo()">Aplicar</button>
      </div>

      <div class="card">
        <div class="muted">Auto-refresh</div>
        <select id="selInt" onchange="aplicarObjetivo()">
          <option value="10000">10 s</option>
          <option value="15000" selected>15 s</option>
          <option value="30000">30 s</option>
          <option value="60000">60 s</option>
        </select>
        <div class="muted">Umbral sin se√±al: <b id="thLbl">40</b> min</div>
      </div>

      <div class="card">
        <div class="muted">Pines: <b id="count">0</b></div>
        <div class="muted">√öltima marca: <b id="last">‚Äî</b> <span id="lag" class="badge">‚Äî</span></div>
        <div class="muted">Estado: <b id="state" class="ok">OK</b></div>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <footer class="muted" style="text-align:center;padding:10px 0 18px">¬© EL VIGILANTE</footer>

<script>
/* ======= CONFIG ======= */
const WORKER_URL = "https://frosty-cake-3ccd.elvigilante1.workers.dev";
const ADMIN_PASS = "maximo3636";
const ALERT_THRESHOLD_MIN = 40;
/* ====================== */

/* Login admin (simple, en cliente) */
document.getElementById('btnAdmin').onclick = async () => {
  const pw = prompt('Contrase√±a de administrador:');
  if (pw === ADMIN_PASS) {
    sessionStorage.setItem('adminOK','1');
    mostrarAdmin(true);
  } else if (pw !== null) {
    alert('Contrase√±a incorrecta');
  }
};
function logoutAdmin(){
  sessionStorage.removeItem('adminOK');
  mostrarAdmin(false);
}
function mostrarAdmin(isAdmin){
  document.getElementById('vigHeader').style.display = isAdmin ? 'none' : '';
  document.getElementById('vigMenu').style.display   = isAdmin ? 'none' : '';
  document.getElementById('adminPanel').style.display= isAdmin ? '' : 'none';
  if (isAdmin) iniciarMapa(); else detenerTimer();
}
if (sessionStorage.getItem('adminOK')==='1') mostrarAdmin(true);

/* ====== Mapa de ADMIN (Leaflet) ====== */
let map, layerPins, bounds=null, timer=null, iniciado=false;

function iniciarMapa(){
  if (iniciado) return;
  iniciado = true;
  document.getElementById('thLbl').textContent = ALERT_THRESHOLD_MIN;
  // valor inicial del objetivo
  const p = new URLSearchParams(location.search);
  document.getElementById('objetivo').value = p.get('objetivo') || 'Objetivo Especial B';

  map = L.map('map',{ zoomControl:true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom:20, attribution:'&copy; OpenStreetMap' }).addTo(map);
  layerPins = L.layerGroup().addTo(map);
  aplicarObjetivo();
}
function detenerTimer(){ if (timer) { clearInterval(timer); timer=null; } }

function fmtAgoMinutes(d){
  return (Date.now()-d.getTime())/60000;
}
function setEstado(ok, minutes){
  const st = document.getElementById('state');
  const lag = document.getElementById('lag');
  if (!ok){ st.textContent='SIN SE√ëAL'; st.className='err'; }
  else if (minutes>ALERT_THRESHOLD_MIN){ st.textContent='TARDE'; st.className='warn'; }
  else { st.textContent='OK'; st.className='ok'; }
  lag.textContent = `${Math.round(minutes)} min`;
}

async function cargarPins(obj){
  const url = `${WORKER_URL}/pins?objetivo=${encodeURIComponent(obj)}&limit=2000`;
  const res = await fetch(url);
  if (!res.ok){ throw new Error(`GET /pins ${res.status}`); }
  const rows = await res.json();

  // pintar
  layerPins.clearLayers(); bounds=null;
  if (!rows.length){
    map.setView([-31.54,-68.52], 13);
    document.getElementById('count').textContent='0';
    document.getElementById('last').textContent='‚Äî';
    setEstado(false, 999);
    return;
  }
  rows.forEach(r=>{
    L.marker([r.lat,r.lng]).addTo(layerPins).bindPopup(`<b>${r.nombre||'‚Äî'}</b><br>${r.objetivo}<br>${r.fechaSJ}`);
    bounds = bounds? bounds.extend([r.lat,r.lng]) : L.latLngBounds([r.lat,r.lng],[r.lat,r.lng]);
  });
  if (bounds) map.fitBounds(bounds,{padding:[30,30]});

  document.getElementById('count').textContent = rows.length.toString();
  const last = new Date(rows[rows.length-1].fechaISO);
  document.getElementById('last').textContent = rows[rows.length-1].fechaSJ;
  setEstado(true, fmtAgoMinutes(last));
}

function aplicarObjetivo(){
  const obj = document.getElementById('objetivo').value.trim();
  if (!obj){ alert('Ingres√° un objetivo'); return; }
  cargarPins(obj).catch(e=>alert(e.message));
  detenerTimer();
  const iv = parseInt(document.getElementById('selInt').value,10) || 15000;
  timer = setInterval(()=>cargarPins(obj).catch(()=>{}), iv);
}
</script>
</body>
</html>
