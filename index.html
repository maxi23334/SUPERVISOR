<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>EL VIGILANTE - Inicio</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    :root{ --bg:#111; --fg:#fff; --muted:#aaa; --card:#181818; --btn:#333; --btnh:#555; --accent:#0ea5e9; }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:'Poppins',sans-serif; background:var(--bg); color:var(--fg);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
    }
    .container{ width:min(900px,92vw); padding:24px; }

    /* Vistas */
    .view{ display:none; text-align:center; }
    .view.active{ display:block; }

    /* Comunes */
    .logo{ width:120px; margin:0 auto 16px; display:block; }
    h1{ font-size:2rem; margin:.25rem 0 1rem; }
    .subtitle{ color:var(--muted); margin-bottom:1.25rem; }
    .menu{ display:flex; flex-direction:column; gap:14px; align-items:center; }

    button, .btn{
      background:var(--btn); color:#fff; border:none; border-radius:10px;
      padding:14px 22px; font-size:1.05rem; cursor:pointer; transition:background .2s ease;
      width:280px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
    }
    button:hover, .btn:hover{ background:var(--btnh); }

    /* Admin (nueva) */
    .cards{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin-top:12px;
    }
    .card{ background:var(--card); border:1px solid #222; border-radius:14px; padding:16px; text-align:left; }
    .card h3{ margin:0 0 8px; font-size:1.05rem; }
    .card p{ margin:0; color:var(--muted); font-size:.95rem; }

    /* Switch flotante */
    .switch{
      position:fixed; right:14px; bottom:14px; background:var(--accent);
      color:#001018; border:none; border-radius:999px; padding:10px 14px; font-weight:600; cursor:pointer;
      box-shadow:0 6px 18px rgba(14,165,233,.35);
    }
    .role-badge{
      display:inline-block; padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:600;
      background:rgba(255,255,255,.08); border:1px solid #2a2a2a; color:#ddd; margin-top:6px;
    }

    /* Vigilador (anterior) */
    .vigilador .menu button{ width:250px; }

    /* Modal contrase√±a */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width:100%; max-width:360px; background:#171717; border:1px solid #262626; border-radius:14px; padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
    }
    .modal-card h3{ margin:0 0 10px; font-size:1.1rem; }
    .modal-card p{ margin:0 0 12px; color:#bbb; font-size:.95rem; }
    .modal-card input{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a2a2a; background:#1f1f1f; color:#fff; outline:none;
    }
    .row{ display:flex; gap:10px; margin-top:12px; }
    .row .btn{ width:100%; justify-content:center; }
    .err{ color:#ff6b6b; font-size:.9rem; margin-top:8px; min-height:1em; }
  </style>
</head>
<body>
  <div class="container">
    <!-- VISTA ADMIN (NUEVA) -->
    <section id="view-admin" class="view">
      <img src="img/escudo.png" alt="Escudo" class="logo">
      <h1>EL VIGILANTE</h1>
      <div class="role-badge">Vista: Admin</div>
      <p class="subtitle">Panel principal</p>

      <div class="cards">
        <div class="card">
          <h3>Accesos r√°pidos</h3>
          <div class="menu" style="margin-top:10px;">
            <a class="btn" href="ingreso-salida.html">üö™ Ingreso y Salida</a>
            <a class="btn" href="rondas.html">üìù Rondas</a>
            <button onclick="location.href='objetivo-mapa.html'">üìç Objetivo (Mapa √∫nico)</button>
          </div>
        </div>
        <div class="card">
          <h3>Reportes</h3>
          <p>Revisa los baches de rondas y el reporte diario (08:00) en Telegram.</p>
        </div>
        <div class="card">
          <h3>Estado</h3>
          <p>WebApp: <span id="status-webapp">‚Äî</span></p>
        </div>
      </div>
    </section>

    <!-- VISTA VIGILADOR (ANTERIOR) -->
    <section id="view-vigilador" class="view vigilador">
      <img src="img/escudo.png" alt="Escudo" class="logo">
      <h1>EL VIGILANTE</h1>
      <div class="role-badge">Vista: Vigilador</div>
      <div class="menu" style="margin-top:16px;">
        <button onclick="location.href='ingreso-salida.html'">üö™ Ingreso y Salida</button>
        <button onclick="location.href='rondas.html'">üìù Rondas</button>
      </div>
    </section>
  </div>

  <!-- Bot√≥n flotante para cambiar vista -->
  <button class="switch" id="btn-switch" title="Cambiar vista">Cambiar vista</button>

  <!-- Modal contrase√±a -->
  <div class="modal" id="pwd-modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Acceso Admin</h3>
      <p>Ingres√° la contrase√±a para ver la vista de administrador.</p>
      <input id="pwd-input" type="password" placeholder="Contrase√±a" autocomplete="current-password">
      <div class="err" id="pwd-err"></div>
      <div class="row">
        <button class="btn" id="pwd-cancel">Cancelar</button>
        <button class="btn" id="pwd-ok">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Config opcional de ping de salud (dejar vac√≠o si no quer√©s) ======
    const WEBAPP_PING_URL = ""; // por ej: "https://script.google.com/.../exec"
    // ========================================================================

    const V_ADMIN = 'admin';
    const V_VIGI  = 'vigilador';

    // SHA-256("maximo3636") en hex (para no exponer texto plano en el c√≥digo)
    const ADMIN_PASS_HASH = "faac93ccc2814d37d89402b846e6089045593a9c2425273638125528ba231de3";

    const qSel = s => document.querySelector(s);
    const viewAdmin = qSel('#view-admin');
    const viewVigi  = qSel('#view-vigilador');
    const btnSwitch = qSel('#btn-switch');

    const modal   = qSel('#pwd-modal');
    const pwdIn   = qSel('#pwd-input');
    const pwdErr  = qSel('#pwd-err');
    const pwdOk   = qSel('#pwd-ok');
    const pwdCancel = qSel('#pwd-cancel');

    // ========= Utilidades =========
    function getParam(name){
      const m = new URLSearchParams(location.search).get(name);
      return m ? String(m) : null;
    }
    function setRole(role){
      localStorage.setItem('role', role);
    }
    function getSavedRole(){
      return localStorage.getItem('role') || V_VIGI;
    }
    async function sha256Hex(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function show(role){
      if (role === V_ADMIN){
        viewAdmin.classList.add('active');
        viewVigi.classList.remove('active');
        btnSwitch.textContent = 'Cambiar a Vigilador';
      } else {
        viewVigi.classList.add('active');
        viewAdmin.classList.remove('active');
        btnSwitch.textContent = 'Cambiar a Admin';
      }
    }

    // ========= Gate de Admin =========
    async function requireAdmin(){
      // ya desbloqueado en esta m√°quina?
      if (localStorage.getItem('adminUnlocked') === '1') return true;

      // abrir modal
      return new Promise(resolve=>{
        pwdErr.textContent = '';
        pwdIn.value = '';
        modal.classList.add('show');
        pwdIn.focus();

        async function tryLogin(){
          const hash = await sha256Hex(pwdIn.value);
          if (hash === ADMIN_PASS_HASH){
            localStorage.setItem('adminUnlocked','1');
            modal.classList.remove('show');
            resolve(true);
          } else {
            pwdErr.textContent = 'Contrase√±a incorrecta.';
            pwdIn.select();
          }
        }

        function cancel(){
          modal.classList.remove('show');
          resolve(false);
        }

        pwdOk.onclick = tryLogin;
        pwdCancel.onclick = cancel;
        pwdIn.onkeydown = (e)=>{ if(e.key==='Enter') tryLogin(); if(e.key==='Escape') cancel(); };
      });
    }

    async function goAdmin(){
      const ok = await requireAdmin();
      if (ok){
        setRole(V_ADMIN);
        show(V_ADMIN);
      } else {
        // si falla, volvemos a vigilador
        setRole(V_VIGI);
        show(V_VIGI);
      }
    }

    // ========= Init =========
    (async function init(){
      // rol por querystring o guardado
      const qRole = getParam('role');
      let role = (qRole===V_ADMIN || qRole===V_VIGI) ? qRole : getSavedRole();

      if (role === V_ADMIN){
        const ok = await requireAdmin();
        role = ok ? V_ADMIN : V_VIGI;
        setRole(role);
      } else {
        setRole(V_VIGI);
      }
      show(role);

      // bot√≥n switch
      btnSwitch.addEventListener('click', async ()=>{
        const current = localStorage.getItem('role') || V_VIGI;
        if (current === V_VIGI) {
          await goAdmin();
        } else {
          setRole(V_VIGI); show(V_VIGI);
        }
      });

      // atajos: Shift+V / Shift+A
      window.addEventListener('keydown', async (e)=>{
        if (!e.shiftKey) return;
        if (e.key.toLowerCase()==='v'){ setRole(V_VIGI); show(V_VIGI); }
        if (e.key.toLowerCase()==='a'){ await goAdmin(); }
      });

      // ping opcional
      if (WEBAPP_PING_URL){
        const el = document.getElementById('status-webapp');
        if (el){
          try{
            const r = await fetch(WEBAPP_PING_URL, { method:'GET', cache:'no-store' });
            el.textContent = r.ok ? 'UP' : ('Error '+r.status);
          }catch(err){ el.textContent = 'Sin conexi√≥n'; }
        }
      }
    })();
  </script>
</body>
</html>

