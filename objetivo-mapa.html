<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Objetivo ‚Äì Mapa √∫nico</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    body{margin:0;font-family:'Poppins',sans-serif;background:#111;color:#fff;display:flex;flex-direction:column;min-height:100vh}
    header,footer{padding:12px 16px;text-align:center}
    h1{margin:8px 0 0}
    .wrap{padding:12px 16px;display:flex;flex-direction:column;gap:10px}
    input,button{width:100%;max-width:360px;padding:10px;font-size:1rem;border-radius:6px;border:none}
    input{background:#222;color:#fff;text-align:center}
    button{background:#333;color:#fff;cursor:pointer} button:hover{background:#555}
    #map{flex:1;min-height:52vh;margin:10px 16px;border-radius:10px;overflow:hidden;border:1px solid #2a2a2a}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .muted{color:#bbb;font-size:.95rem}
    #status{margin:0 16px 8px;padding:8px 12px;border:1px solid #2a2a2a;border-radius:8px;background:#151515;white-space:pre-line}
  </style>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- reCAPTCHA v3 (SITE KEY p√∫blica) -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Le3k8MrAAAAAPzVkceNA4vkkOxWLxUvh9pFJzH3" async defer></script>
</head>
<body>
  <header>
    <h1>Objetivo ‚Äì Mapa √∫nico</h1>
    <p class="muted">Cada toque agrega un pin al mismo mapa (para este objetivo).</p>
  </header>

  <div class="wrap">
    <input id="nombre" placeholder="Ingrese su nombre">
    <div class="row">
      <button id="btnMark">üìç Marcar ahora</button>
      <button id="btnRefresh">üîÑ Refrescar mapa</button>
      <button onclick="location.href='./index.html'">‚¨Ö Volver</button>
    </div>
    <div class="muted">Objetivo fijo: <b id="objLbl"></b></div>
  </div>

  <pre id="status">Listo.</pre>
  <div id="map"></div>

  <footer class="muted">Mapa: ¬© OpenStreetMap, Leaflet</footer>

  <script>
    // ====== CONFIG ======
    const WORKER_URL = "https://frosty-cake-3ccd.elvigilante1.workers.dev";
    const RECAPTCHA_SITE_KEY = "6Le3k8MrAAAAAPzVkceNA4vkkOxWLxUvh9pFJzH3";
    const OBJETIVO_FIJO = "Objetivo Especial B"; // cambia si quieres otro

    // ====== Helpers UI/diag ======
    const $s = (t) => { console.log(t); const el=document.getElementById('status'); el.textContent = (el.textContent? el.textContent+"\n":"")+t; };
    const setBusy = (on) => { document.getElementById('btnMark').disabled = on; document.getElementById('btnMark').textContent = on ? "‚è≥ Enviando..." : "üìç Marcar ahora"; };

    // ====== reCAPTCHA helper ======
    function recaptchaToken() {
      return new Promise((resolve, reject) => {
        if (!window.grecaptcha) return reject(new Error('reCAPTCHA no cargado'));
        grecaptcha.ready(() => {
          grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' })
            .then(resolve).catch(reject);
        });
      });
    }

    async function postRegistro(tipo, nombre, objetivo, lat, lng) {
      const token = await recaptchaToken();
      $s("reCAPTCHA OK (token generado)");
      const res = await fetch(WORKER_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ tipo, nombre, objetivo, lat, lng, recaptchaToken: token })
      });
      const txt = await res.text();
      $s(`POST ${res.status} ‚Üí ${txt}`);
      if (!res.ok) throw new Error(txt || `HTTP ${res.status}`);
      return txt;
    }

    // ====== Mapa ======
    document.getElementById('objLbl').textContent = OBJETIVO_FIJO;
    const map = L.map('map', { zoomControl:true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);
    const layer = L.layerGroup().addTo(map);
    let bounds = null;

    function fit() { if (bounds) map.fitBounds(bounds, { padding:[30,30] }); }
    async function cargarPins() {
      try{
        layer.clearLayers(); bounds = null;
        const url = `${WORKER_URL}/pins?objetivo=${encodeURIComponent(OBJETIVO_FIJO)}&limit=1000`;
        $s(`GET /pins ‚Ä¶`);
        const res = await fetch(url);
        const body = await res.text();
        $s(`GET /pins ${res.status}`);
        if (!res.ok){ throw new Error(body || `HTTP ${res.status}`); }
        const rows = JSON.parse(body);
        if (!rows.length){ map.setView([-31.54, -68.52], 13); return; }
        rows.forEach(r => {
          L.marker([r.lat, r.lng]).addTo(layer).bindPopup(`<b>${r.nombre || '‚Äî'}</b><br>${r.objetivo}<br>${r.fechaSJ}`);
          bounds = bounds ? bounds.extend([r.lat, r.lng]) : L.latLngBounds([r.lat, r.lng], [r.lat, r.lng]);
        });
        fit();
      }catch(e){
        $s('Error cargando pins: '+e.message);
        alert('Error cargando pins: '+e.message);
      }
    }

    async function marcarAhora() {
      try{
        setBusy(true);
        const nombre = document.getElementById('nombre').value.trim();
        if (!nombre) { alert('Ingres√° tu nombre'); return; }
        if (!navigator.geolocation) { alert('Geolocalizaci√≥n no soportada'); return; }

        $s('Solicitando geolocalizaci√≥n‚Ä¶');
        navigator.geolocation.getCurrentPosition(async pos => {
          try{
            const { latitude:lat, longitude:lng } = pos.coords;
            $s(`Posici√≥n OK: ${lat}, ${lng}`);
            const r = await postRegistro('ObjetivoPin', nombre, OBJETIVO_FIJO, lat, lng);
            $s('Guardado OK: '+r);
            await cargarPins();
          }catch(err){
            $s('Fallo al guardar: '+err.message);
            alert('No se pudo guardar: '+err.message);
          }finally{ setBusy(false); }
        }, err => {
          const m = {1:'Permiso denegado',2:'Posici√≥n no disponible',3:'Timeout'}[err.code] || 'Error de geolocalizaci√≥n';
          $s('Geo error: '+m);
          alert(m);
          setBusy(false);
        }, { enableHighAccuracy:true, timeout:12000, maximumAge:1000 });

      }catch(e){
        $s('Error: '+e.message);
        alert(e.message);
        setBusy(false);
      }
    }

    document.getElementById('btnMark').addEventListener('click', marcarAhora);
    document.getElementById('btnRefresh').addEventListener('click', cargarPins);
    cargarPins();
  </script>
</body>
</html>
