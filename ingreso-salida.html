<script>
  const WORKER_URL = "https://YOUR-WORKER.workers.dev"; // <-- tu URL del Worker
  const RECAPTCHA_SITE_KEY = "YOUR_RECAPTCHA_SITE_KEY"; // <-- tu site key v3

  async function recaptchaToken() {
    await grecaptcha.ready();
    return grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' });
  }
  async function postRegistro(tipo, nombre, objetivo, lat, lng) {
    const recaptcha = await recaptchaToken();
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tipo, nombre, objetivo, lat, lng, recaptchaToken: recaptcha })
    });
    const txt = await res.text();
    if (!res.ok) throw new Error(txt || 'Error al guardar');
    return txt;
  }
  function staticMapURL(label, lat, lng) {
    const qs = new URLSearchParams({ label, lat, lng, zoom: '18', size: '640x400' });
    return `${WORKER_URL}/map?${qs.toString()}`;
  }
  function nowFmt() { return new Date().toLocaleString(); }
  function dlName(prefix, nombre) {
    return `${prefix}_${nombre.replace(/\s+/g,'_')}_${new Date().toISOString().replace(/[:.-]/g,'_')}.png`;
  }

  async function generar() {
    const nombre = document.getElementById('nombre').value.trim();
    const objetivo = document.getElementById('objetivo').value.trim();
    if (!nombre || !objetivo) { alert('Complet√° ambos campos.'); return; }

    const out = document.getElementById('output');
    out.innerHTML = '<p>Obteniendo ubicaci√≥n‚Ä¶</p>';

    if (!navigator.geolocation) { alert('Geolocalizaci√≥n no soportada.'); return; }

    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;

      // 1) Guardar
      try { await postRegistro('Ingreso/Salida', nombre, objetivo, lat, lng); }
      catch(e){ alert('No se pudo guardar: ' + e.message); }

      // 2) Mapa v√≠a Worker (CORS OK) + descarga autom√°tica con sello
      const dateStr = nowFmt();
      const url = staticMapURL('I', lat, lng);
      const img = new Image();
      img.crossOrigin = "anonymous"; // importante
      img.src = url;

      img.onload = () => {
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
        ctx.drawImage(img, 0, 0);
        ctx.fillStyle = 'rgba(0,0,0,.5)'; ctx.fillRect(10,10,360,84);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 16px Poppins';
        ctx.fillText(`üë§ ${nombre}`, 20, 36);
        ctx.fillText(`üéØ ${objetivo}`, 20, 60);
        ctx.fillText(`üìÖ ${dateStr}`, 20, 84);

        // Mostrar en pantalla (opcional)
        const finalImg = new Image();
        finalImg.src = canvas.toDataURL('image/png');
        out.innerHTML = "";
        out.appendChild(finalImg);

        // Descarga autom√°tica
        const a = document.createElement('a');
        a.href = finalImg.src;
        a.download = dlName('ingreso_salida', nombre);
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      };

      img.onerror = () => {
        out.innerHTML = "<p>No se pudo generar el PNG del mapa (CORS/Worker). Revis√° el Worker.</p>";
      };

    }, geoError, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
  }

  function geoError(err) {
    const m = { 1:'Permiso denegado', 2:'Posici√≥n no disponible', 3:'Timeout' }[err.code] || 'Error de geolocalizaci√≥n';
    alert(m);
  }
</script>




