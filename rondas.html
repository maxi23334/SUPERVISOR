<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rondas</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Poppins', sans-serif; background-color: #111; color: #fff;
               display: flex; flex-direction: column; align-items: center; justify-content: center;
               min-height: 100vh; padding: 20px; }
        h1 { font-size: 2rem; margin-bottom: 20px; }
        input, button { width: 250px; padding: 10px; margin: 10px 0; font-size: 1rem;
                        border-radius: 5px; border: none; }
        input { background-color: #222; color: white; text-align: center; }
        button { background-color: #333; color: white; cursor: pointer;
                 transition: background-color 0.3s ease; }
        button:hover { background-color: #555; }
        #output { margin-top: 20px; text-align: center; width: 100%; max-width: 600px; }
        img { max-width: 100%; border-radius: 10px; margin-top: 15px; }
    </style>
</head>
<body>

    <h1>Rondas</h1>
    <input type="text" id="nombre" placeholder="Ingrese su nombre">
    <input type="text" id="objetivo" placeholder="Ingrese el objetivo">
    <button onclick="generarMapa()">Generar Mapa</button>
    <button onclick="location.href='index.html'" style="margin-top: 10px;">‚¨Ö Volver al Inicio</button>

    <div id="output"></div>
    <canvas id="mapCanvas" style="display:none;"></canvas>

    <script>
       const webAppUrl = "https://script.google.com/macros/s/AKfycbz7dn59Osn7gv0aouMdB7tZhA4yJ9cwXwFTJZDB_oBxkoUcRcWEf646bXwv9MtyDd_d/exec";


        function generarMapa() {
            const nombre = document.getElementById("nombre").value;
            const objetivo = document.getElementById("objetivo").value;
            if (!nombre || !objetivo) {
                alert("Por favor, complete ambos campos.");
                return;
            }

            document.getElementById("output").innerHTML = "<p>Obteniendo ubicaci√≥n...</p>";

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const date = new Date();
                    const formattedDate = date.toLocaleString();
                    const zoomLevel = 18;
                    const apiKey = "AIzaSyCgBKlv8-PhVtIt-QcZLwR9ZHpSTnugb8M";

                    const imageUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=${zoomLevel}&size=600x400&maptype=satellite&markers=color:blue|label:R|${lat},${lng}&key=${apiKey}`;

                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = imageUrl;

                    img.onload = function () {
                        const canvas = document.getElementById("mapCanvas");
                        const ctx = canvas.getContext("2d");
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        ctx.font = "bold 16px Poppins";
                        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                        ctx.fillRect(10, 10, 250, 70);
                        ctx.fillStyle = "white";
                        ctx.fillText(`üë§ ${nombre}`, 20, 30);
                        ctx.fillText(`üéØ ${objetivo}`, 20, 50);
                        ctx.fillText(`üìÖ ${formattedDate}`, 20, 70);

                        const finalImg = new Image();
                        finalImg.src = canvas.toDataURL("image/png");
                        const outputDiv = document.getElementById("output");
                        outputDiv.innerHTML = "";
                        outputDiv.appendChild(finalImg);

                        // Guardar en Google Sheets
                        fetch(webAppUrl, {
                            method: "POST",
                            body: JSON.stringify({
                                tipo: "Ronda",
                                nombre: nombre,
                                objetivo: objetivo,
                                lat: lat,
                                lng: lng
                            }),
                            headers: { "Content-Type": "application/json" }
                        }).then(r => console.log("Guardado en Sheets", r));

                        // Descargar la imagen
                        const a = document.createElement("a");
                        a.href = canvas.toDataURL("image/png");
                        a.download = `ronda_${nombre.replace(/\s+/g, "_")}_${date.toISOString().replace(/[:.-]/g, "_")}.png`;
                        document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    };
                }, showError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            } else {
                alert("La geolocalizaci√≥n no es compatible con este navegador.");
            }
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED: alert("El usuario deneg√≥ la geolocalizaci√≥n."); break;
                case error.POSITION_UNAVAILABLE: alert("Ubicaci√≥n no disponible."); break;
                case error.TIMEOUT: alert("Tiempo agotado."); break;
                default: alert("Error desconocido.");
            }
        }
    </script>
</body>
</html>


