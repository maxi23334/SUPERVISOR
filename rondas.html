<script>
  const webAppUrl = "https://script.google.com/macros/s/AKfycbwi3yDCm1mr0HmmWGYR34osBQiqQ5SiT6yotUDypnzCDk9vk2HnvFQ5kD1sfJmM-DGM/exec";
  const apiKey = "AIzaSyCgBKlv8-PhVtIt-QcZLwR9ZHpSTnugb8M";

  async function enviarRegistro(tipo, nombre, objetivo, lat, lng) {
    const res = await fetch(webAppUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Cache-Control": "no-store" },
      body: JSON.stringify({ tipo, nombre, objetivo, lat, lng })
    });
    const txt = await res.text();
    console.log("Servidor:", txt);
    alert("Servidor: " + txt);
    return txt;
  }

  function generarMapa() {
    const nombre = document.getElementById("nombre").value.trim();
    const objetivo = document.getElementById("objetivo").value.trim();
    if (!nombre || !objetivo) {
      alert("Por favor, complete ambos campos.");
      return;
    }

    document.getElementById("output").innerHTML = "<p>Obteniendo ubicación...</p>";

    if (!navigator.geolocation) {
      alert("La geolocalización no es compatible con este navegador.");
      return;
    }

    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const date = new Date();
      const formattedDate = date.toLocaleString();
      const zoomLevel = 18;

      // 1) Guardar primero en Sheets
      try {
        await enviarRegistro("Ronda", nombre, objetivo, lat, lng);
      } catch (e) {
        alert("No se pudo enviar a la planilla: " + e);
        console.error(e);
      }

      // 2) Generar imagen de mapa (independiente)
      const imageUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=${zoomLevel}&size=600x400&maptype=satellite&markers=color:blue|label:R|${lat},${lng}&key=${apiKey}`;

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = imageUrl;

      img.onload = function () {
        const canvas = document.getElementById("mapCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        ctx.font = "bold 16px Poppins";
        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
        ctx.fillRect(10, 10, 280, 72);
        ctx.fillStyle = "white";
        ctx.fillText(`👤 ${nombre}`, 20, 32);
        ctx.fillText(`🎯 ${objetivo}`, 20, 52);
        ctx.fillText(`📅 ${formattedDate}`, 20, 72);

        const finalImg = new Image();
        finalImg.src = canvas.toDataURL("image/png");
        const outputDiv = document.getElementById("output");
        outputDiv.innerHTML = "";
        outputDiv.appendChild(finalImg);

        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = `ronda_${nombre.replace(/\s+/g, "_")}_${date.toISOString().replace(/[:.-]/g, "_")}.png`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      };

      img.onerror = function () {
        console.warn("No se pudo cargar la imagen del mapa. Igual se guardó el registro.");
        const outputDiv = document.getElementById("output");
        outputDiv.innerHTML = "<p>Registro guardado. (No se pudo cargar el mapa)</p>";
      };
    }, showError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
  }

  function showError(error) {
    switch (error.code) {
      case error.PERMISSION_DENIED: alert("El usuario denegó la geolocalización."); break;
      case error.POSITION_UNAVAILABLE: alert("La ubicación no está disponible."); break;
      case error.TIMEOUT: alert("Tiempo agotado al obtener la ubicación."); break;
      default: alert("Error desconocido obteniendo la ubicación.");
    }
  }
</script>



